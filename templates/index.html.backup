<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integratd living - Automated Quoting Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #556B2F 0%, #3D4F1F 100%); color: white; padding: 40px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        
        /* Tab Navigation */
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #ddd; }
        .tab { flex: 1; padding: 20px; text-align: center; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab:hover { background: #e9ecef; }
        .tab.active { color: #556B2F; border-bottom-color: #556B2F; background: white; }
        
        .tab-content { display: none; padding: 40px; }
        .tab-content.active { display: block; }
        
        .upload-section { background: #f8f9fa; border-radius: 15px; padding: 40px; margin-bottom: 30px; border: 2px dashed #556B2F; cursor: pointer; transition: all 0.3s; text-align: center; }
        .upload-section:hover { background: #e9ecef; transform: translateY(-2px); }
        .upload-icon { font-size: 4em; margin-bottom: 20px; }
        input[type="file"] { display: none; }
        .form-group { margin-bottom: 25px; }
        label { display: block; font-weight: 600; color: #556B2F; margin-bottom: 10px; font-size: 1.1em; }
        input[type="text"], input[type="number"], textarea { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; transition: border 0.3s; font-family: inherit; }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus { outline: none; border-color: #556B2F; }
        textarea { min-height: 120px; resize: vertical; }
        .tier-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .tier-card { background: #f8f9fa; border: 2px solid #ddd; border-radius: 12px; padding: 20px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .tier-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .tier-card.selected { background: #556B2F; color: white; border-color: #556B2F; }
        .automation-types { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .checkbox-card { background: #f8f9fa; border: 2px solid #ddd; border-radius: 12px; padding: 20px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .checkbox-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .checkbox-card.selected { background: #556B2F; color: white; border-color: #556B2F; }
        .checkbox-card .symbol { font-size: 2.5em; margin-bottom: 10px; }
        .checkbox-card .name { font-weight: 600; }
        .btn-primary { width: 100%; padding: 20px; background: linear-gradient(135deg, #556B2F 0%, #3D4F1F 100%); color: white; border: none; border-radius: 12px; font-size: 1.2em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(85, 107, 47, 0.3); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .loading { display: none; text-align: center; padding: 40px; }
        .loading.active { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #556B2F; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .results { display: none; margin-top: 30px; padding: 30px; background: #f8f9fa; border-radius: 15px; }
        .results.active { display: block; }
        .results h2 { color: #556B2F; margin-bottom: 20px; }
        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .result-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .result-card h3 { color: #556B2F; margin-bottom: 10px; font-size: 1.1em; }
        .result-card p { font-size: 2em; font-weight: 600; color: #333; }
        .download-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 25px; }
        .download-btn { padding: 15px 25px; background: #556B2F; color: white; text-decoration: none; border-radius: 10px; text-align: center; font-weight: 600; transition: all 0.3s; display: block; }
        .download-btn:hover { background: #3D4F1F; transform: translateY(-2px); }
        .alert { padding: 20px; border-radius: 10px; margin: 20px 0; display: none; }
        .alert.active { display: block; }
        .alert-error { background: #fee; border: 1px solid #fcc; color: #c33; }
        .alert-success { background: #efe; border: 1px solid #cfc; color: #363; }
        .alert-info { background: #e7f3ff; border: 1px solid #b3d9ff; color: #004085; }
        
        .file-list { margin-top: 20px; }
        .file-item { padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .file-item .remove-btn { background: #c33; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; }
        .file-item .remove-btn:hover { background: #a22; }
        
        .info-box { background: #e7f3ff; border-left: 4px solid #2196F3; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .info-box h3 { color: #2196F3; margin-bottom: 10px; }
        .info-box ul { margin-left: 20px; line-height: 1.8; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
        
        .section-title { color: #556B2F; font-size: 1.5em; margin: 30px 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #556B2F; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Integratd living</h1>
            <p>AI-Powered Quoting & Learning System</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('quote')">üìä Generate Quote</div>
            <div class="tab" onclick="switchTab('train')">üéì Train & Configure AI</div>
        </div>

        <!-- QUOTE TAB -->
        <div id="quote-tab" class="tab-content active">
            <div class="upload-section" onclick="document.getElementById('floorplan').click()">
                <div class="upload-icon">üìÑ</div>
                <h2>Upload Floor Plan PDF</h2>
                <p>Click to select or drag & drop your floor plan</p>
                <input type="file" id="floorplan" accept=".pdf" onchange="handleFileSelect(this)">
                <p id="filename" style="margin-top: 15px; font-weight: 600; color: #556B2F;"></p>
            </div>

            <div class="form-group">
                <label for="project_name">Project Name</label>
                <input type="text" id="project_name" placeholder="Enter project name..." value="Residential Project">
            </div>

            <div class="form-group">
                <label>Select Tier</label>
                <div class="tier-selection">
                    <div class="tier-card selected" data-tier="basic" onclick="selectTier(this, 'basic')">
                        <h3>Basic</h3>
                        <p>Essential automation</p>
                    </div>
                    <div class="tier-card" data-tier="premium" onclick="selectTier(this, 'premium')">
                        <h3>Premium</h3>
                        <p>Advanced features</p>
                    </div>
                    <div class="tier-card" data-tier="deluxe" onclick="selectTier(this, 'deluxe')">
                        <h3>Deluxe</h3>
                        <p>Luxury automation</p>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Select Automation Types</label>
                <div class="automation-types">
                    <div class="checkbox-card" data-type="lighting" onclick="toggleAutomation(this)">
                        <div class="symbol">üí°</div>
                        <div class="name">Lighting Control</div>
                    </div>
                    <div class="checkbox-card" data-type="shading" onclick="toggleAutomation(this)">
                        <div class="symbol">ü™ü</div>
                        <div class="name">Shading Control</div>
                    </div>
                    <div class="checkbox-card" data-type="security_access" onclick="toggleAutomation(this)">
                        <div class="symbol">üîê</div>
                        <div class="name">Security & Access</div>
                    </div>
                    <div class="checkbox-card" data-type="climate" onclick="toggleAutomation(this)">
                        <div class="symbol">üå°</div>
                        <div class="name">Climate Control</div>
                    </div>
                    <div class="checkbox-card" data-type="audio" onclick="toggleAutomation(this)">
                        <div class="symbol">üîä</div>
                        <div class="name">Audio System</div>
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="analyzeFloorplan()">üöÄ Analyze & Generate Quote</button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <h3>Analyzing floor plan...</h3>
                <p>Reading text, detecting rooms, calculating costs...</p>
            </div>

            <div class="alert alert-error" id="error"></div>
            <div class="results" id="results">
                <h2>‚úÖ Analysis Complete!</h2>
                <div class="result-grid">
                    <div class="result-card">
                        <h3>Rooms Detected</h3>
                        <p id="rooms">0</p>
                    </div>
                    <div class="result-card">
                        <h3>Doors Found</h3>
                        <p id="doors">0</p>
                    </div>
                    <div class="result-card">
                        <h3>Windows Found</h3>
                        <p id="windows">0</p>
                    </div>
                    <div class="result-card">
                        <h3>Total Cost</h3>
                        <p id="total">$0.00</p>
                    </div>
                </div>
                <div class="download-buttons">
                    <a href="#" class="download-btn" id="download-annotated">üìÑ Download Annotated Plan</a>
                    <a href="#" class="download-btn" id="download-quote">üí∞ Download Quote</a>
                </div>
            </div>
        </div>

        <!-- TRAIN & CONFIGURE TAB -->
        <div id="train-tab" class="tab-content">
            
            <h2 class="section-title">üì§ Upload Training Data</h2>
            <div class="info-box">
                <h3>üéØ Help AI Learn from Real Projects</h3>
                <p>Upload floor plans, images, and add notes to continuously improve detection accuracy.</p>
            </div>

            <div class="upload-section" onclick="document.getElementById('learning-files').click()">
                <div class="upload-icon">üìö</div>
                <h2>Upload Floor Plans & Images</h2>
                <p>Select multiple PDFs and images</p>
                <input type="file" id="learning-files" accept=".pdf,.png,.jpg,.jpeg" multiple onchange="handleLearningFiles(this)">
            </div>

            <div id="file-list" class="file-list" style="display: none;">
                <h3 style="color: #556B2F; margin-bottom: 15px;">Selected Files:</h3>
                <div id="file-items"></div>
            </div>

            <div class="form-group">
                <label for="learning-notes">Training Notes & Context</label>
                <textarea id="learning-notes" placeholder="Example: 'These are 3-bedroom residential plans with open kitchens. Each bedroom has 2 windows. Total area ~150sqm.'"></textarea>
            </div>

            <button class="btn-primary" onclick="uploadLearningData()">üì§ Upload Training Data</button>

            <div class="loading" id="learning-loading">
                <div class="spinner"></div>
                <h3>Uploading training data...</h3>
            </div>

            <div class="alert alert-error" id="learning-error"></div>
            <div class="alert alert-success" id="learning-success"></div>

            <h2 class="section-title">üí∞ Update Pricing & Configuration</h2>
            
            <div class="grid-2">
                <div class="form-group">
                    <label for="labor-rate">Labor Rate ($/hour)</label>
                    <input type="number" id="labor-rate" value="75" step="5">
                </div>
                <div class="form-group">
                    <label for="markup">Markup Percentage (%)</label>
                    <input type="number" id="markup" value="20" step="5">
                </div>
            </div>

            <div class="form-group">
                <label>Lighting Control Prices</label>
                <div class="grid-2">
                    <input type="number" id="lighting-basic" placeholder="Basic $" value="150">
                    <input type="number" id="lighting-premium" placeholder="Premium $" value="250">
                </div>
            </div>

            <div class="form-group">
                <label>Shading Control Prices</label>
                <div class="grid-2">
                    <input type="number" id="shading-basic" placeholder="Basic $" value="300">
                    <input type="number" id="shading-premium" placeholder="Premium $" value="500">
                </div>
            </div>

            <button class="btn-primary" onclick="updatePricing()">üíæ Save Pricing</button>

            <div class="alert alert-success" id="pricing-success"></div>
            <div class="alert alert-error" id="pricing-error"></div>

            <h2 class="section-title">üí¨ Natural Language Instructions</h2>
            <div class="info-box">
                <h3>ü§ñ Tell AI How to Improve</h3>
                <p>Give instructions in plain English to adjust detection rules, pricing logic, or quote formatting.</p>
            </div>

            <div class="form-group">
                <label for="nl-instructions">Your Instructions</label>
                <textarea id="nl-instructions" placeholder="Example: 'When you see "BR" in floor plan text, that means bedroom. Count those as rooms. Also, increase lighting prices by 10% for commercial projects.'"></textarea>
            </div>

            <button class="btn-primary" onclick="submitInstructions()">üéØ Apply Instructions</button>

            <div class="alert alert-success" id="instructions-success"></div>
            <div class="alert alert-error" id="instructions-error"></div>

        </div>
    </div>

    <script>
        let selectedFile = null;
        let selectedTier = 'basic';
        let selectedAutomation = new Set();
        let learningFiles = [];

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function handleFileSelect(input) {
            selectedFile = input.files[0];
            document.getElementById('filename').textContent = selectedFile ? `Selected: ${selectedFile.name}` : '';
        }

        function selectTier(element, tier) {
            document.querySelectorAll('.tier-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            selectedTier = tier;
        }

        function toggleAutomation(element) {
            const type = element.dataset.type;
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                selectedAutomation.delete(type);
            } else {
                element.classList.add('selected');
                selectedAutomation.add(type);
            }
        }

        async function analyzeFloorplan() {
            if (!selectedFile) {
                showAlert('error', 'Please upload a floor plan PDF first');
                return;
            }
            if (selectedAutomation.size === 0) {
                showAlert('error', 'Please select at least one automation type');
                return;
            }

            const formData = new FormData();
            formData.append('floorplan', selectedFile);
            formData.append('project_name', document.getElementById('project_name').value);
            formData.append('tier', selectedTier);
            selectedAutomation.forEach(type => formData.append('automation_types[]', type));

            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            hideAlert('error');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('rooms').textContent = data.analysis.rooms_detected;
                    document.getElementById('doors').textContent = data.analysis.doors_detected;
                    document.getElementById('windows').textContent = data.analysis.windows_detected;
                    document.getElementById('total').textContent = `$${data.costs.grand_total.toFixed(2)}`;
                    document.getElementById('download-annotated').href = data.files.annotated_pdf;
                    document.getElementById('download-quote').href = data.files.quote_pdf;
                    document.getElementById('results').classList.add('active');
                } else {
                    showAlert('error', data.error || 'Analysis failed');
                }
            } catch (error) {
                showAlert('error', 'Error: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        function handleLearningFiles(input) {
            learningFiles = Array.from(input.files);
            displayFileList();
        }

        function displayFileList() {
            const fileList = document.getElementById('file-list');
            const fileItems = document.getElementById('file-items');
            
            if (learningFiles.length === 0) {
                fileList.style.display = 'none';
                return;
            }

            fileList.style.display = 'block';
            fileItems.innerHTML = '';

            learningFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span>üìÑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    <button class="remove-btn" onclick="removeFile(${index})">Remove</button>
                `;
                fileItems.appendChild(item);
            });
        }

        function removeFile(index) {
            learningFiles.splice(index, 1);
            displayFileList();
        }

        async function uploadLearningData() {
            if (learningFiles.length === 0) {
                showAlert('learning-error', 'Please select at least one file');
                return;
            }

            const formData = new FormData();
            learningFiles.forEach(file => formData.append('files[]', file));
            formData.append('notes', document.getElementById('learning-notes').value);

            document.getElementById('learning-loading').classList.add('active');
            hideAlert('learning-error');
            hideAlert('learning-success');

            try {
                const response = await fetch('/api/upload-learning-data', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    showAlert('learning-success', `‚úÖ Successfully uploaded ${learningFiles.length} files! Batch ID: ${data.batch_id}`);
                    learningFiles = [];
                    document.getElementById('learning-files').value = '';
                    document.getElementById('learning-notes').value = '';
                    displayFileList();
                } else {
                    showAlert('learning-error', data.error);
                }
            } catch (error) {
                showAlert('learning-error', 'Error: ' + error.message);
            } finally {
                document.getElementById('learning-loading').classList.remove('active');
            }
        }

        async function updatePricing() {
            const data = {
                labor_rate: parseFloat(document.getElementById('labor-rate').value),
                markup_percentage: parseFloat(document.getElementById('markup').value),
                automation_types: {
                    lighting: {
                        base_cost_per_unit: {
                            basic: parseFloat(document.getElementById('lighting-basic').value),
                            premium: parseFloat(document.getElementById('lighting-premium').value)
                        }
                    },
                    shading: {
                        base_cost_per_unit: {
                            basic: parseFloat(document.getElementById('shading-basic').value),
                            premium: parseFloat(document.getElementById('shading-premium').value)
                        }
                    }
                }
            };

            try {
                const response = await fetch('/api/update-pricing', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.success) {
                    showAlert('pricing-success', '‚úÖ Pricing updated successfully!');
                } else {
                    showAlert('pricing-error', result.error);
                }
            } catch (error) {
                showAlert('pricing-error', 'Error: ' + error.message);
            }
        }

        async function submitInstructions() {
            const instructions = document.getElementById('nl-instructions').value.trim();
            if (!instructions) {
                showAlert('instructions-error', 'Please enter some instructions');
                return;
            }

            try {
                const response = await fetch('/api/process-instructions', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({instructions})
                });
                const result = await response.json();

                if (result.success) {
                    showAlert('instructions-success', '‚úÖ Instructions saved! AI will apply these rules going forward.');
                    document.getElementById('nl-instructions').value = '';
                } else {
                    showAlert('instructions-error', result.error);
                }
            } catch (error) {
                showAlert('instructions-error', 'Error: ' + error.message);
            }
        }

        function showAlert(id, message) {
            const alert = document.getElementById(id);
            alert.textContent = message;
            alert.classList.add('active');
        }

        function hideAlert(id) {
            document.getElementById(id).classList.remove('active');
        }
    </script>
</body>
</html>
