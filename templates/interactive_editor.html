<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Floor Plan Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }

        .editor-container {
            display: flex;
            height: 100vh;
        }

        .canvas-area {
            flex: 1;
            background: white;
            position: relative;
            overflow: auto;
        }

        #floorplanCanvas {
            display: block;
            cursor: crosshair;
            max-width: 100%;
            height: auto;
        }

        .sidebar {
            width: 350px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .symbol-palette {
            margin-bottom: 30px;
        }

        .symbol-palette h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #3498db;
        }

        .symbol-button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: #34495e;
            border: 2px solid #3498db;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .symbol-button:hover {
            background: #3498db;
            transform: translateX(5px);
        }

        .symbol-button.active {
            background: #3498db;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.5);
        }

        .price-display {
            background: #1a252f;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .price-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #34495e;
        }

        .price-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2em;
            color: #2ecc71;
            padding-top: 15px;
            margin-top: 10px;
            border-top: 2px solid #2ecc71;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2ecc71;
            color: white;
        }

        .btn-primary:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .placed-symbols-list {
            max-height: 300px;
            overflow-y: auto;
            background: #1a252f;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .symbol-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #34495e;
            margin-bottom: 8px;
            border-radius: 5px;
        }

        .symbol-item:hover {
            background: #3498db;
        }

        .delete-symbol {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .delete-symbol:hover {
            background: #c0392b;
        }

        .instructions {
            background: #3498db;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .symbol-on-canvas {
            position: absolute;
            font-size: 24px;
            cursor: move;
            user-select: none;
            transition: transform 0.1s;
        }

        .symbol-on-canvas:hover {
            transform: scale(1.2);
        }

        .symbol-on-canvas.dragging {
            opacity: 0.7;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="canvas-area">
            <canvas id="floorplanCanvas"></canvas>
        </div>

        <div class="sidebar">
            <h2>üé® Floor Plan Editor</h2>

            <div class="instructions">
                <strong>How to use:</strong><br>
                1. Click a symbol type below<br>
                2. Click on floor plan to place<br>
                3. Drag symbols to move them<br>
                4. Watch live price update!
            </div>

            <div class="price-display">
                <h3>üí∞ Live Quote</h3>
                <div class="price-item">
                    <span>üí° Lighting:</span>
                    <span id="lightingCost">$0.00</span>
                </div>
                <div class="price-item">
                    <span>ü™ü Shading:</span>
                    <span id="shadingCost">$0.00</span>
                </div>
                <div class="price-item">
                    <span>üîê Security:</span>
                    <span id="securityCost">$0.00</span>
                </div>
                <div class="price-item">
                    <span>üå° Climate:</span>
                    <span id="climateCost">$0.00</span>
                </div>
                <div class="price-item">
                    <span>üîä Audio:</span>
                    <span id="audioCost">$0.00</span>
                </div>
                <div class="price-item">
                    <span>TOTAL:</span>
                    <span id="totalCost">$0.00</span>
                </div>
            </div>

            <div class="symbol-palette">
                <h3>Add Symbols</h3>
                <button class="symbol-button" data-type="lighting" data-symbol="üí°">
                    üí° Add Lighting Control
                </button>
                <button class="symbol-button" data-type="shading" data-symbol="ü™ü">
                    ü™ü Add Shading Control
                </button>
                <button class="symbol-button" data-type="security_access" data-symbol="üîê">
                    üîê Add Security & Access
                </button>
                <button class="symbol-button" data-type="climate" data-symbol="üå°">
                    üå° Add Climate Control
                </button>
                <button class="symbol-button" data-type="audio" data-symbol="üîä">
                    üîä Add Audio System
                </button>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="approveAndGeneratePDF()">
                    ‚úÖ Approve & Generate PDF
                </button>
                <button class="btn btn-secondary" onclick="clearAll()">
                    üóëÔ∏è Clear All Symbols
                </button>
                <button class="btn btn-secondary" onclick="undo()">
                    ‚Ü©Ô∏è Undo Last
                </button>
            </div>

            <div class="placed-symbols-list">
                <h3>Placed Symbols</h3>
                <div id="symbolsList"></div>
            </div>
        </div>
    </div>

    <script>
        // State
        let floorplanImage = null;
        let symbols = [];
        let selectedSymbolType = null;
        let selectedSymbol = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let canvas = null;
        let ctx = null;

        // Pricing data (should match backend)
        const pricing = {
            lighting: { basic: 150, premium: 250, deluxe: 400 },
            shading: { basic: 300, premium: 500, deluxe: 800 },
            security_access: { basic: 500, premium: 900, deluxe: 1500 },
            climate: { basic: 400, premium: 700, deluxe: 1200 },
            audio: { basic: 350, premium: 600, deluxe: 1000 }
        };
        const tier = 'basic'; // Can be changed
        const markup = 0.20; // 20%

        // Initialize
        window.onload = function() {
            canvas = document.getElementById('floorplanCanvas');
            ctx = canvas.getContext('2d');

            // Load floor plan from session or upload
            loadFloorPlan();

            // Symbol button clicks
            document.querySelectorAll('.symbol-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.symbol-button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedSymbolType = this.dataset.type;
                    selectedSymbol = this.dataset.symbol;
                });
            });

            // Canvas click to place symbol
            canvas.addEventListener('click', placeSymbol);
            canvas.addEventListener('mousedown', startDrag);
            canvas.addEventListener('mousemove', drag);
            canvas.addEventListener('mouseup', endDrag);
        };

        function loadFloorPlan() {
            // In real implementation, load from uploaded PDF
            // For now, create a placeholder
            canvas.width = 1200;
            canvas.height = 800;
            ctx.fillStyle = '#ecf0f1';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#34495e';
            ctx.font = '20px Arial';
            ctx.fillText('Floor Plan Will Appear Here', canvas.width/2 - 150, canvas.height/2);
            ctx.fillText('(Upload PDF in main app first)', canvas.width/2 - 150, canvas.height/2 + 30);
        }

        function placeSymbol(e) {
            if (!selectedSymbolType) {
                alert('Please select a symbol type first!');
                return;
            }

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            symbols.push({
                type: selectedSymbolType,
                symbol: selectedSymbol,
                x: x,
                y: y,
                id: Date.now()
            });

            redrawCanvas();
            updatePricing();
            updateSymbolsList();
        }

        function startDrag(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Find if we clicked on a symbol
            for (let i = symbols.length - 1; i >= 0; i--) {
                const sym = symbols[i];
                if (x >= sym.x - 15 && x <= sym.x + 15 && y >= sym.y - 15 && y <= sym.y + 15) {
                    isDragging = true;
                    selectedSymbolForDrag = sym;
                    dragOffset = { x: x - sym.x, y: y - sym.y };
                    break;
                }
            }
        }

        function drag(e) {
            if (!isDragging) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            selectedSymbolForDrag.x = x - dragOffset.x;
            selectedSymbolForDrag.y = y - dragOffset.y;

            redrawCanvas();
        }

        function endDrag() {
            isDragging = false;
            selectedSymbolForDrag = null;
        }

        function redrawCanvas() {
            // Redraw floor plan
            loadFloorPlan();

            // Draw all symbols
            ctx.font = '24px Arial';
            symbols.forEach(sym => {
                ctx.fillText(sym.symbol, sym.x - 12, sym.y + 8);
            });
        }

        function updatePricing() {
            const counts = {
                lighting: 0,
                shading: 0,
                security_access: 0,
                climate: 0,
                audio: 0
            };

            symbols.forEach(sym => counts[sym.type]++);

            let total = 0;
            for (let type in counts) {
                const count = counts[type];
                const cost = count * pricing[type][tier];
                total += cost;
                document.getElementById(type.replace('_', '') + 'Cost').textContent = '$' + cost.toFixed(2);
            }

            const grandTotal = total * (1 + markup);
            document.getElementById('totalCost').textContent = '$' + grandTotal.toFixed(2);
        }

        function updateSymbolsList() {
            const list = document.getElementById('symbolsList');
            list.innerHTML = '';
            symbols.forEach((sym, idx) => {
                const item = document.createElement('div');
                item.className = 'symbol-item';
                item.innerHTML = `
                    <span>${sym.symbol} ${sym.type}</span>
                    <button class="delete-symbol" onclick="deleteSymbol(${idx})">Delete</button>
                `;
                list.appendChild(item);
            });
        }

        function deleteSymbol(idx) {
            symbols.splice(idx, 1);
            redrawCanvas();
            updatePricing();
            updateSymbolsList();
        }

        function clearAll() {
            if (confirm('Clear all symbols?')) {
                symbols = [];
                redrawCanvas();
                updatePricing();
                updateSymbolsList();
            }
        }

        function undo() {
            if (symbols.length > 0) {
                symbols.pop();
                redrawCanvas();
                updatePricing();
                updateSymbolsList();
            }
        }

        function approveAndGeneratePDF() {
            alert('Generating PDF with ' + symbols.length + ' symbols...');
            // Send symbols array to backend to generate PDF
            console.log('Symbols to save:', symbols);
            // In real implementation: POST to /api/generate-final-quote
        }
    </script>
</body>
</html>
