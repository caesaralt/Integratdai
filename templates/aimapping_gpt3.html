<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Mapping (Protocol 3)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#0b0f14;color:#e6edf3}
    header{display:flex;gap:16px;align-items:center;padding:16px 24px;background:#111827;border-bottom:1px solid #1f2937}
    header a{color:#e6edf3;text-decoration:none;opacity:.9}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:20px;margin-bottom:16px}
    .btn{background:#2563eb;border:0;border-radius:8px;color:#fff;padding:10px 14px;cursor:pointer}
    input[type="file"]{background:#0b1220;border:1px solid #1f2937;color:#e6edf3;border-radius:8px;padding:10px;width:100%}
    pre{white-space:pre-wrap;background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:12px;max-height:300px;overflow:auto}
  </style>
</head>
<body>
  <header>
    <strong>Integratd</strong>
    <a href="/">Home</a>
    <a href="/quotes">Quote Automation</a>
    <a href="/canvas">Floor Plan Canvas</a>
    <a href="/crm">CRM</a>
    <a href="/ai-mapping">AI Mapping (Protocol 3)</a>
  </header>
  <main>
    <div class="card">
      <h2>Protocol 3: AI Mapping</h2>
      <p>Upload a plan, get structured extraction, then routing with smarter models. This page uses the Phase‑2 endpoints today; we’ll switch to Structured Outputs + tool-calls next.</p>
      <form id="p3form">
        <input type="file" id="p3file" accept=".pdf,.png,.jpg,.jpeg" required>
        <div style="margin-top:12px">
          <button class="btn" type="submit">Analyze + Route</button>
        </div>
      </form>
    </div>
    <div class="card">
      <h3>Status</h3>
      <pre id="p3status">Idle.</pre>
      <h3>Result</h3>
      <pre id="p3result">{}</pre>
      <div id="p3svg" style="margin-top:12px"></div>
    </div>
  </main>
<script>
const $ = s => document.querySelector(s);
const st = $("#p3status"), rs = $("#p3result"), svgDiv = $("#p3svg");
document.getElementById("p3form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const f = document.getElementById("p3file").files[0];
  if(!f) return;
  try{
    st.textContent = "Uploading to /api/plan/understand ...";
    const fd = new FormData(); fd.append("file", f);
    const u = await fetch("/api/plan/understand", {method:"POST", body:fd});
    if(!u.ok) throw new Error("understand failed "+u.status);
    const uj = await u.json(); rs.textContent = JSON.stringify(uj,null,2);

    st.textContent = "Routing via /api/plan/route ...";
    const r = await fetch("/api/plan/route", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({floorplan: uj.floorplan})
    });
    if(!r.ok) throw new Error("route failed "+r.status);
    const rj = await r.json(); rs.textContent = JSON.stringify(rj,null,2);

    if(rj.svg_url){
      const resp = await fetch(rj.svg_url);
      const txt = await resp.text();
      svgDiv.innerHTML = txt;
    } else {
      st.textContent = "No svg_url returned.";
    }
  }catch(err){
    st.textContent = "Error: "+err.message;
  }
});
</script>
</body>
</html>
